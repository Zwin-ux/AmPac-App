rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- DEFAULT DENY ---
    // Lock down all documents by default.
    // Specific rules below will override this for intended access.
    match /{document=**} {
      allow read, write: if false;
    }

    // Helper functions
    function isAuthenticated() {
      return request.auth != null || currentUserId() == 'dev-user';
    }

    function currentUserId() {
      return request.auth != null ? request.auth.uid : 'dev-user';
    }

    function isOwner(userId) {
      return currentUserId() == userId;
    }

    function hasUserDoc() {
      return request.auth != null && exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isStaff() {
      return isAuthenticated() && hasUserDoc() && getUserData().role == 'ampac_staff';
    }

    function isAdmin() {
      return isAuthenticated() && hasUserDoc() && (getUserData().role == 'admin' || getUserData().staffRole == 'admin');
    }

    function isApplicationOwnerData(appData) {
      return appData.userId == currentUserId() || appData.primaryBorrowerUserId == currentUserId();
    }

    function applicationExists(appId) {
      return exists(/databases/$(database)/documents/applications/$(appId));
    }

    function isApplicationOwner(appId) {
      let appData = get(/databases/$(database)/documents/applications/$(appId)).data;
      return isApplicationOwnerData(appData);
    }

    function disallowClientFields(changedKeys, disallowed) {
      return !changedKeys.hasAny(disallowed);
    }

    // --- USERS ---
    match /users/{userId} {
      // Users can read and write their own profile
      // Staff can read all user profiles
      allow read: if isAuthenticated() && (isOwner(userId) || isStaff());
      allow write: if isAuthenticated() && isOwner(userId);

      // Blocked users subcollection (client-managed)
      match /blocked/{blockedUserId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // --- APPLICATIONS ---
    match /applications/{appId} {
      // Allow reads if authenticated staff or owner, or allow the special 'dev-user' to read dev-owned apps.
      allow read: if (
        (isAuthenticated() && (isStaff() || isApplicationOwnerData(resource.data))) ||
        (currentUserId() == 'dev-user' && resource.data.userId == 'dev-user')
      );

      // Client apps must never write Ventures-owned sync fields; Brain (Admin SDK) bypasses rules.
      function hasDisallowedApplicationFieldsOnCreate() {
        return request.resource.data.keys().hasAny([
          'venturesLoanId',
          'venturesStatus',
          'lastSyncedAt'
        ]);
      }

      function hasDisallowedApplicationFieldChanges() {
        return !disallowClientFields(
          request.resource.data.diff(resource.data).changedKeys(),
          [
            'venturesLoanId',
            'venturesStatus',
            'lastSyncedAt'
          ]
        );
      }

      // Borrower creates/updates only their own application.
      allow create: if isAuthenticated() && (
        // Staff can create for borrowers via internal tools
        isStaff() ||
        (
          request.resource.data.userId == request.auth.uid &&
          !hasDisallowedApplicationFieldsOnCreate()
        )
      );

      allow update: if isAuthenticated() && (
        isStaff() ||
        (
          resource.data.userId == request.auth.uid &&
          request.resource.data.userId == resource.data.userId &&
          !hasDisallowedApplicationFieldChanges()
        )
      );

      allow delete: if isAdmin();
    }

    // --- TASKS ---
    match /tasks/{taskId} {
      allow read: if isAuthenticated() && (
        isStaff() ||
        (resource.data.loanApplicationId != null && isApplicationOwner(resource.data.loanApplicationId))
      );

      // Tasks are staff/Brain-managed; borrowers should not update task status directly.
      allow create, update: if isStaff();
      allow delete: if isAdmin();
    }

    // --- ROOMS ---
    match /rooms/{roomId} {
      // Public read
      allow read: if true;
      // Only admins can write rooms
      allow write: if isAuthenticated() && isAdmin();
    }

    // --- BOOKINGS ---
    match /bookings/{bookingId} {
      
      function isValidBooking(bookingData) {
        return bookingData.keys().hasAll(['userId', 'roomId', 'startTime', 'endTime']) &&
               bookingData.userId is string &&
               bookingData.roomId is string &&
               bookingData.startTime is timestamp &&
               bookingData.endTime is timestamp &&
               bookingData.startTime > request.time &&
               bookingData.endTime > bookingData.startTime;
      }

      // Users can read their own bookings, Staff can read all
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isStaff());
      
      // Users can create valid bookings for themselves
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid &&
                     isValidBooking(request.resource.data);

      // Users can update/cancel their own bookings; staff can update any
      // Updates must also be valid
      allow update: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || isStaff()) &&
                     isValidBooking(request.resource.data);
      
      // No deletions allowed for audit trail
      allow delete: if false;
    }

    // --- HOLDS (Spaces booking anti-collision) ---
    // Note: holds contain no PII; readable for availability checks.
    match /holds/{holdId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if false;
    }

    // --- SUPPORT / HOTLINE ---
    match /hotlineRequests/{requestId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isStaff());
      allow update: if isStaff();
      allow delete: if false;
    }
    
    // --- BUSINESSES (Network & Groups) ---
    match /businesses/{businessId} {
        allow read: if true;

        function isBusinessOwner() {
            return isAuthenticated() && (
                businessId == request.auth.uid || 
                resource.data.ownerId == request.auth.uid ||
                resource.data.members[request.auth.uid] == 'owner'
            );
        }

        function isBusinessAdmin() {
            return isAuthenticated() && (
                isBusinessOwner() || 
                resource.data.members[request.auth.uid] == 'admin'
            );
        }

        // Create: Auth user can create their own business listing.
        allow create: if isAuthenticated() && (isStaff() || request.resource.data.ownerId == request.auth.uid);

        // Update: Owner/Admin can update; Any Auth user can join if they have the inviteCode (via specific atomic update).
        allow update: if isAuthenticated() && (
            isStaff() || 
            isBusinessAdmin() ||
            (
                // Allow "Join" logic: User can only add themselves as 'member' if inviteCode matches.
                request.resource.data.diff(resource.data).changedKeys().hasOnly(['members']) &&
                request.resource.data.members[request.auth.uid] == 'member' &&
                request.resource.data.inviteCode == resource.data.inviteCode
            )
        );

        allow delete: if isAdmin() || isBusinessOwner();
    }

    // --- CHAT & SOCIAL ---
    match /organizations/{orgId}/channels/{channelId} {
      // Community channels are readable/queryable by anyone (including unauthenticated)
      // for public engagement. Other orgs are restricted to public or members.
      // Use currentUserId() helper to support dev-user in development.
      function isMember() {
        return resource.data.members != null && currentUserId() in resource.data.members;
      }
      
      allow read: if 
          orgId == 'ampac-community' ||
          (isAuthenticated() && (
              resource.data.type == 'public' || 
              isMember()
          ));
      
      allow create: if isAuthenticated(); 
      // Update: members only (e.g. adding members)
      allow update: if isAuthenticated() && (
          orgId == 'ampac-community' ||
          resource.data.type == 'public' ||
          isMember()
      );
      
      match /messages/{messageId} {
         // Helper: Check if user can access parent channel
         function canAccessChannel() {
           let channelData = get(/databases/$(database)/documents/organizations/$(orgId)/channels/$(channelId)).data;
           return channelData.type == 'public' || 
                  (channelData.members != null && currentUserId() in channelData.members);
         }
         
         // Read: Must be able to read parent channel
         allow read: if isAuthenticated() && canAccessChannel();
         // Create: If public channel, anyone can post. If private, only members.
         allow create: if isAuthenticated() && 
             request.resource.data.senderId == currentUserId() &&
             canAccessChannel();
         // Update: Only sender can edit their own message
         allow update, delete: if isAuthenticated() && resource.data.senderId == currentUserId();
      }
    }
    
    // --- REPORTS (For UGC Compliance) ---
    match /reports/{reportId} {
        allow create: if isAuthenticated();
        allow read: if isStaff(); // Only staff/admin
        allow update, delete: if isStaff();
    }
    
    match /posts/{postId} {
       allow read: if true;
       allow create: if isAuthenticated() && 
           request.resource.data.authorId == request.auth.uid &&
           disallowClientFields(request.resource.data.keys(), ['featured', 'pinned']);

       // Allow likes by any authenticated user, but only allow author to change other fields.
       allow update: if isAuthenticated() && (
         (
             resource.data.authorId == request.auth.uid && 
             disallowClientFields(request.resource.data.diff(resource.data).changedKeys(), ['featured', 'pinned'])
         ) ||
         request.resource.data.diff(resource.data).changedKeys().hasOnly(['likes']) ||
         isStaff()
       );

       allow delete: if isAuthenticated() && (resource.data.authorId == request.auth.uid || isStaff());
    }

    match /events/{eventId} {
       allow read: if true;
       allow create: if isAuthenticated() && 
           disallowClientFields(request.resource.data.keys(), ['featured', 'pinned']);
       
       allow update: if isAuthenticated() && (
         (
             resource.data.organizerId == request.auth.uid && 
             disallowClientFields(request.resource.data.diff(resource.data).changedKeys(), ['featured', 'pinned'])
         ) ||
         request.resource.data.diff(resource.data).changedKeys().hasAny(['attendees', 'engagementScore']) ||
         isStaff()
       );
       
       allow delete: if isAuthenticated() && (resource.data.organizerId == request.auth.uid || isStaff());
    }

    // --- DOCUMENT REQUESTS & UPLOADED DOCUMENTS ---
    match /document_requests/{requestId} {
      allow read: if isAuthenticated() && (
        isStaff() ||
        (resource.data.loanApplicationId != null && isApplicationOwner(resource.data.loanApplicationId))
      );
      allow create, update: if isStaff();
      allow delete: if isAdmin();
    }

    match /documents/{documentId} {
      allow read: if isAuthenticated() && (
        isStaff() ||
        (resource.data.loanApplicationId != null && isApplicationOwner(resource.data.loanApplicationId))
      );
      // Borrowers can create document records for their own application uploads.
      allow create: if isAuthenticated() &&
        request.resource.data.uploadedBy == request.auth.uid &&
        request.resource.data.loanApplicationId != null &&
        isApplicationOwner(request.resource.data.loanApplicationId);
      allow update: if isStaff();
      allow delete: if isAdmin();
    }

    // --- PAYMENTS (Console only) ---
    match /payments/{paymentId} {
      allow read, write: if isStaff();
      allow delete: if isAdmin();
    }

    // --- MARKETPLACE ---
    match /marketplace_items/{itemId} {
      allow read: if true;
      allow write: if isStaff();
    }

    // --- PRELIMINARY LEADS (Lite Intake) ---
    match /preliminary_leads/{leadId} {
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow read: if isAuthenticated() && (resource.data.userId == request.auth.uid || isStaff());
        allow update: if isStaff();
        allow delete: if isAdmin();
    }

    // --- ORGANIZATIONS & CHANNELS ---
    // Note: Primary channel rules are in the CHAT & SOCIAL section above.
    // This just adds organization-level read permissions.
    match /organizations/{orgId} {
      allow read: if isAuthenticated();
    }

    // --- STANDALONE CHANNELS (Business private channels) ---
    match /channels/{channelId} {
        allow read: if isAuthenticated() && (
            currentUserId() in resource.data.members ||
            isStaff()
        );
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && (
            currentUserId() in resource.data.members ||
            isStaff()
        );
        allow delete: if isAdmin();
    }

    // --- PERSONAL CALENDAR EVENTS ---
    match /calendar_events/{eventId} {
        allow read: if isAuthenticated() && (
            resource.data.userId == request.auth.uid ||
            isStaff()
        );
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update: if isAuthenticated() && (
            resource.data.userId == request.auth.uid ||
            isStaff()
        );
        allow delete: if isAuthenticated() && (
            resource.data.userId == request.auth.uid ||
            isStaff()
        );
    }

    // --- CALENDAR REMINDERS ---
    match /calendar_reminders/{reminderId} {
        allow read: if isAuthenticated() && (
            resource.data.userId == request.auth.uid ||
            isStaff()
        );
        allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if isAuthenticated() && (
            resource.data.userId == request.auth.uid ||
            isStaff()
        );
    }

    // --- COMMENTS (Feed/Post comments) ---
    match /comments/{commentId} {
        allow read: if true;
        allow create: if isAuthenticated() && request.resource.data.authorId == request.auth.uid;
        allow update: if isAuthenticated() && (
            resource.data.authorId == request.auth.uid ||
            isStaff()
        );
        allow delete: if isAuthenticated() && (
            resource.data.authorId == request.auth.uid ||
            isStaff()
        );
    }

    // --- NOTIFICATIONS ---
    match /notifications/{notificationId} {
        allow read: if isAuthenticated() && isOwner(resource.data.userId);
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && isOwner(resource.data.userId);
        allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // --- SUPPORT NOTIFICATIONS ---
    match /support_notifications/{notificationId} {
        allow create: if isAuthenticated();
        allow read: if isStaff();
        allow update: if isStaff();
        allow delete: if isAdmin();
    }

    // --- GLOBAL EVENTS (Community Calendar) ---
    match /globalEvents/{eventId} {
        allow read: if true; // Public events are readable by all
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && (
            resource.data.organizerId == request.auth.uid ||
            request.resource.data.diff(resource.data).changedKeys().hasOnly(['attendees']) ||
            isStaff()
        );
        allow delete: if isAuthenticated() && (
            resource.data.organizerId == request.auth.uid ||
            isStaff()
        );
    }

    // --- EVENT SUBSCRIPTIONS ---
    match /eventSubscriptions/{userId} {
        allow read: if isAuthenticated() && request.auth.uid == userId;
        allow write: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}
